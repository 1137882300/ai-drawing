---
import Layout from '../layouts/Layout.astro';

// 格式化日期
function formatDate(date: Date): string {
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    }).replace(',', ' ');
}

// 获取初始页面数据
const initialResponse = await fetch(`${Astro.url.origin}/api/album-images?page=1`);
const { images: initialImages, hasMore: initialHasMore } = await initialResponse.json();

// 获取页码（如果有的话）
const currentPage = Number(Astro.url.searchParams.get('page') || 1);

// 在文件顶部添加类型定义
interface ImageItem {
    url: string;
    key: string;
    lastModified: string | Date;
}
---

<Layout title="Album - Daily Poetry Images">
    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">相册</h1>
        
        <div 
            id="image-grid" 
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 
                   gap-2 sm:gap-4 
                   auto-rows-min"
        >
            {initialImages.map((image: ImageItem) => (
                <div class="masonry-item relative group cursor-pointer" data-url={image.url}>
                    <div class="relative overflow-hidden rounded-lg">
                        <img 
                            src={image.url}
                            alt={`Image from ${image.key}`}
                            class="w-full h-auto object-cover 
                                   transform transition-transform duration-300 
                                   group-hover:scale-105"
                            loading="lazy"
                        />
                        <div class="absolute bottom-0 left-0 right-0 
                                    bg-black bg-opacity-50 text-white 
                                    p-2 rounded-b-lg">
                            <p class="text-xs sm:text-sm truncate">
                                {formatDate(new Date(image.lastModified!))}
                            </p>
                        </div>
                    </div>
                </div>
            ))}
        </div>

        {initialHasMore && (
            <div class="flex justify-center mt-8">
                <button 
                    id="load-more" 
                    class="px-4 py-2 bg-blue-500 text-white rounded 
                           hover:bg-blue-600 transition-colors"
                >
                    加载更多
                </button>
            </div>
        )}

        <!-- 图片弹窗 -->
        <div 
            id="image-modal" 
            class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden 
                   items-center justify-center p-4"
        >
            <div class="relative max-w-full max-h-full">
                <img 
                    id="modal-image" 
                    src="" 
                    alt="Enlarged image" 
                    class="max-w-full max-h-[90vh] object-contain"
                />
                <button 
                    id="close-modal" 
                    class="absolute top-2 right-2 text-white 
                           bg-red-500 rounded-full p-2 
                           hover:bg-red-600 transition-colors"
                >
                    关闭
                </button>
            </div>
        </div>
    </main>

    <script define:vars={{ currentPage }}>
    document.addEventListener('DOMContentLoaded', () => {
        const loadMoreBtn = document.getElementById('load-more');
        const imageGrid = document.getElementById('image-grid');

        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', async () => {
                try {
                    const page = currentPage + 1;
                    const response = await fetch(`/api/album-images?page=${page}`);
                    const { images, hasMore } = await response.json();

                    images.forEach((image) => {
                        const div = document.createElement('div');
                        div.className = 'masonry-item relative group cursor-pointer';
                        div.dataset.url = image.url;
                        
                        div.innerHTML = `
                            <div class="relative overflow-hidden rounded-lg">
                                <img 
                                    src="${image.url}"
                                    alt="Image from ${image.key}"
                                    class="w-full h-auto object-cover 
                                           transform transition-transform duration-300 
                                           group-hover:scale-105"
                                    loading="lazy"
                                />
                                <div class="absolute bottom-0 left-0 right-0 
                                            bg-black bg-opacity-50 text-white 
                                            p-2 rounded-b-lg">
                                    <p class="text-xs sm:text-sm truncate">
                                        ${new Date(image.lastModified).toLocaleString('zh-CN', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit',
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit',
                                            hour12: false
                                        }).replace(',', ' ')}
                                    </p>
                                </div>
                            </div>
                        `;
                        
                        if (imageGrid) {
                            imageGrid.appendChild(div);
                        }
                    });

                    if (!hasMore && loadMoreBtn) {
                        loadMoreBtn.style.display = 'none';
                    }
                } catch (error) {
                    console.error('加载更多图片失败:', error);
                }
            });
        }
    });
    </script>
</Layout>